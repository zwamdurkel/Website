function Flow(e){this.files=[],this.paused=!1,this.averageSpeed=0,this.completedFiles=0,this.uploadingFiles=0,this.size=0,this.completedBytes=0,this.defaults={chunkSize:!1,singleFile:!1,fileParameterName:"file",progressCallbacksInterval:500,speedSmoothingFactor:.1,query:{},headers:{},withCredentials:!1,target:"/",generateUniqueIdentifier:null,maxChunkRetries:0,resumeLargerThan:0,chunkRetryInterval:null,maxSimultaneous:1},this.opts={},this.events={};var t=this;this.onDrop=function(e){e.stopPropagation(),e.preventDefault();var i=e.dataTransfer||e.clipboardData;i.items&&i.items[0]&&i.items[0].webkitGetAsEntry?t.webkitReadDataTransfer(e):t.addFiles(i.files,e)},this.opts=this.extend({},this.defaults,e||{})}Flow.prototype={on:function(e,t){e=e.toLowerCase(),this.events.hasOwnProperty(e)||(this.events[e]=[]),this.events[e].push(t)},off:function(e,t){void 0!==e?(e=e.toLowerCase(),void 0!==t?this.events.hasOwnProperty(e)&&arrayRemove(this.events[e],t):delete this.events[e]):this.events={}},fire:function(e,t){t=Array.prototype.slice.call(arguments),e=e.toLowerCase();var i=!1;return this.events.hasOwnProperty(e)&&this.each(this.events[e],function(e){i=!1===e.apply(this,t.slice(1))||i}),"catchall"!=e&&(t.unshift("catchAll"),i=!1===this.fire.apply(this,t)||i),!i},webkitReadDataTransfer:function(e){var t=this,i=e.dataTransfer.items,s=i.length,h=[];function r(e,t){e.relativePath=t,h.push(e),n()}function o(e){throw e}function n(){0==--s&&t.addFiles(h,e)}this.each(i,function(e){var i=e.webkitGetAsEntry();i?i.isFile?r(e.getAsFile(),i.fullPath):function e(i){i.readEntries(function(h){h.length?(s+=h.length,t.each(h,function(t){if(t.isFile){var i=t.fullPath;t.file(function(e){r(e,i)},o)}else t.isDirectory&&e(t.createReader())}),e(i)):n()},o)}(i.createReader()):n()})},generateUniqueIdentifier:function(e){var t=this.opts.generateUniqueIdentifier;if("function"==typeof t)return t(e);var i=e.relativePath||e.webkitRelativePath||e.fileName||e.name;return e.size+"-"+i.replace(/[^0-9a-zA-Z_-]/gim,"")},browseFiles:function(e,t){FlowUtils.browseFiles({entireFolder:e,singleFile:t,onSelect:function(e,t){e.length>0&&this.addFiles(e,t)},scope:this})},start:function(){this.paused=!1,this.uploadNextFile(),this.fire("uploadStart")},uploadNextFile:function(){if(this.paused)return!1;var e=0,t=0,i=!0;this.each(this.files,function(s){if(!s.complete)if(s.queuePaused)e++;else if(s.uploading)t++;else{if(!(this.uploadingFiles<this.opts.maxSimultaneous))return!1;i=!1,s.start()}},this),!i||e||t||this.fire("complete")},pause:function(){this.paused=!0,this.each(this.files,function(e){e.queuePaused||e.paused||e.complete||e.pause()}),this.uploadingFiles=0},removeAll:function(){for(var e=this.files.length-1;e>=0;e--)this.removeFile(this.files[e]);this.averageSpeed=0,this.uploadingFiles=0},getProgress:function(){return 0==this.size&&0==this.completedBytes?1:this.completedBytes/this.size},onFileSuccess:function(e,t){this.uploadingFiles--,this.completedFiles++,this.fire("progress",this),this.fire("fileSuccess",e,t),this.uploadNextFile()},onFileError:function(e,t){this.uploadingFiles--,this.fire("fileError",e,t),this.fire("error",t,e)},onFilePause:function(e,t,i){i&&this.uploadingFiles--,t&&this.uploadNextFile(),this.fire("fileProgress",e)},onFileStart:function(){this.uploadingFiles++},addFile:function(e,t){this.addFiles([e],t)},addFiles:function(e,t){this.each(e,function(e){if(this.opts.singleFile&&this.files.length>0)return!1;if((e.size%4096!=0||"."!==e.name&&"."!==e.fileName)&&!this.getFromUniqueIdentifier(this.generateUniqueIdentifier(e))){var i=new FlowFile(this,e);this.fire("fileAdded",i,t)&&(this.files.push(i),this.size+=i.size)}},this),this.fire("filesSubmitted",this.files,t),this.opts.startOnSubmit&&this.start()},removeFile:function(e){for(var t=!1,i=this.files.length-1;i>=0;i--)this.files[i]===e&&(this.size-=e.size,e.uploading&&(e.uploadingChunk&&e.uploadingChunk.abort(),t=!0,this.uploadingFiles--),e.complete&&this.completedFiles--,this.completedBytes-=e.completedBytes,e=null,this.files.splice(i,1));return t&&this.uploadNextFile(),!0},getFromUniqueIdentifier:function(e){var t=!1;return this.each(this.files,function(i){i.uniqueIdentifier===e&&(t=i)}),t},timeRemaining:function(){var e=this.size-this.completedBytes;return e&&!this.averageSpeed?Number.POSITIVE_INFINITY:e||this.averageSpeed?Math.floor(e/this.averageSpeed):0},arrayRemove:function(e,t){var i=e.indexOf(t);i>-1&&e.splice(i,1)},extend:function(e,t){return this.each(arguments,function(t){t!==e&&this.each(t,function(t,i){e[i]=t})},this),e},each:function(e,t,i){if(e)if(void 0!==e.length){for(var s=0;s<e.length;s++)if(!1===t.call(i,e[s],s))return}else for(var s in e)if(e.hasOwnProperty(s)&&!1===t.call(i,e[s],s))return}};var FlowUtils={browserSupport:{files:void 0!==window.File&&"undefined"!=typeof Blob&&void 0!==window.FileList&&(void 0!==Blob.prototype.slice||void 0!==Blob.prototype.webkitSlice||void 0!==Blob.prototype.mozSlice),folders:!0},browseFiles:function(e){var t=document.createElement("input");t.setAttribute("type","file"),e.singleFile||(t.setAttribute("multiple","multiple"),e.entireFolder&&(t.setAttribute("webkitdirectory","webkitdirectory"),t.setAttribute("directory","directory"))),t.style.display="none",t.addEventListener("change",function(t){e.onSelect.call(e.scope,t.target.files,t),document.body.removeChild(this)},!1),document.body.appendChild(t),t.click()}};function FlowFile(e,t){(this.flowObj=e,this.file=t,this.size=t.size,this.name=t.fileName||t.name,/(iPad|iPhone|iPod)/g.test(navigator.userAgent)&&"image"==this.name.substring(0,5)&&(this.name="image_"+this.size+this.name.substring(5)),this.relativePath=t.relativePath||t.webkitRelativePath||!1,this.relativePath&&this.relativePath!=this.name)&&(baseNameStartPos=this.relativePath.length-this.name.length,this.relativePath.substring(baseNameStartPos)==this.name&&(this.relativePath=this.relativePath.substring(0,baseNameStartPos)));this.uniqueIdentifier=e.generateUniqueIdentifier(t),this.offset=0,this.chunks=[],this.uploadingChunk=!1,this.completedChunks=0,this.completedBytes=0,this.lastCompletedBytes=0,this.complete=!1,this.uploading=!1,this.paused=!1,this.progress=0,this.queuePaused=!1,this.error=!1,this.averageSpeed=0,this.currentSpeed=0,this._lastProgressCallback=Date.now(),this._prevTransferredSize=0}function FlowChunk(e,t,i){this.flowObj=e,this.fileObj=t,this.fileObjSize=t.size,this.offset=i,this.retries=0,this.pendingRetry=!1,this.loaded=0,this._lastLoaded=0,this.total=0,this.flowObj.opts.chunkSize?this.startByte=t.offset+this.offset*this.flowObj.opts.chunkSize:this.startByte=0,this.flowObj.opts.chunkSize?this.endByte=Math.min(this.fileObjSize,this.startByte+this.flowObj.opts.chunkSize):this.endByte=this.fileObjSize,this.size=this.endByte-this.startByte,this.xhr=null;var s=this;this.progressHandler=function(e){if(e.lengthComputable){if(s.loaded=Math.min(e.loaded,s.size),s.total=Math.min(e.total,s.size),s.loaded>s._lastLoaded){var t=s.loaded-s._lastLoaded;s.fileObj.completedBytes+=t,s.flowObj.completedBytes+=t}s._lastLoaded=s.loaded}s.fileObj.chunkEvent("progress")},this.doneHandler=function(e){var t=s.status(),i=s.message();if("success"===t)s.retries=0,s.fileObj.completedChunks++,s.fileObj.chunkEvent("success",i);else if(s.fileObj.uploadingChunk=!1,s.abort(),"error"===t)s.retries=0,s.fileObj.chunkEvent("error",i);else if(s.retries<s.flowObj.opts.maxChunkRetries){s.retries++;var h=s.flowObj.opts.chunkRetryInterval;null!==h?(s.retries>1&&(h*=s.retries),setTimeout(function(){s.send()},h)):s.send()}else s.retries=0,s.fileObj.chunkEvent("error",i)}}FlowUtils.DropZone=function(e){FlowUtils.browserSupport.files&&(this.opts=e,e.domNode.addEventListener("dragenter",function(e){e.preventDefault();var t=this.opts.findTarget.call(this.opts.scope,e,this);t&&this.manager.addHighLight(t,this.opts.overClass)}.bind(this),!1),e.domNode.addEventListener("dragover",function(e){e.dataTransfer.dropEffect="copy",e.stopPropagation(),e.preventDefault()}.bind(this),!1),e.domNode.addEventListener("drop",function(e){if(e.stopPropagation(),e.preventDefault(),this.manager.removeHighlight(),0==e.dataTransfer.files.length)return FR.UI.feedback&&FR.UI.feedback(FR.T("To upload files, drag them from your computer")),!1;var t=this.opts.findTarget.call(this.opts.scope,e,this);t&&this.opts.onDrop.call(this.opts.scope,e,t)}.bind(this),!1))},FlowUtils.DropZoneManager={zones:[],lastTarget:!1,add:function(e){if(FlowUtils.browserSupport.files){var t=new FlowUtils.DropZone(e);t.manager=this,this.zones.push(t)}},addHighLight:function(e,t){var i=this.lastTarget;i&&i.el.classList.remove(i.cls),e.el.classList.add(t),this.lastTarget={el:e.el,cls:t},window.setTimeout(function(){FlowUtils.DropZoneManager.removeHighlight()},3e3)},removeHighlight:function(){this.lastTarget&&this.lastTarget.el.classList.remove(this.lastTarget.cls)}},FlowFile.prototype={measureSpeed:function(){var e=Date.now()-this._lastProgressCallback;if(e){var t=this.flowObj.opts.speedSmoothingFactor;this.currentSpeed=Math.max((this.completedBytes-this._prevTransferredSize)/e*1e3,0),this.averageSpeed=t*this.currentSpeed+(1-t)*this.averageSpeed,this.flowObj.averageSpeed=this.averageSpeed,this._prevTransferredSize=this.completedBytes}},chunkEvent:function(e,t){switch(e){case"progress":if(Date.now()-this._lastProgressCallback<this.flowObj.opts.progressCallbacksInterval)break;this.reportProgress();break;case"error":this.error=!0,this.paused=!0,this.flowObj.paused=!0,this.flowObj.completedBytes-=this.completedBytes,this.completedBytes=0,this.reset(),this.flowObj.onFileError(this,t);break;case"success":this.error=!1,this.paused=!1,this.removeUploadingChunk(this.uploadingChunk),this.completedChunks==this.chunks.length?(this.reportProgress(),this.uploading=!1,this.complete=!0,this.currentSpeed=0,this.averageSpeed=0,this.flowObj.onFileSuccess(this,t),this.file=null):this.uploadNextChunk();break;case"retry":this.flowObj.fire("fileRetry",this)}},reportProgress:function(){this.measureProgress(),this.measureSpeed(),this.flowObj.fire("fileProgress",this),this.flowObj.fire("progress",this.flowObj),this._lastProgressCallback=Date.now()},uploadNextChunk:function(){this.paused||this.flowObj.each(this.chunks,function(e){if(e&&"pending"===e.status())return e.send(),!1})},getOffsetHandler:function(e){this.offset=0;var t=this.xhr.status,i=this.xhr.responseText;this.xhr=null,this.flowObj.opts.validateGetOffsetResponse.call(this.flowObj.opts.validateGetOffsetResponseScope||this,this,t,i)?(this.lastCompletedBytes=this.completedBytes,this.completedBytes=this.offset,this.lastCompletedBytes>0&&(this.flowObj.completedBytes-=this.lastCompletedBytes),this.flowObj.completedBytes+=this.offset,this.prepareChunks(),this.uploadNextChunk()):(this.error=!0,this.uploading=!1,this.flowObj.onFileError(this,i))},getOffset:function(){this.xhr=new XMLHttpRequest,this.xhr.addEventListener("load",this.getOffsetHandler.bind(this),!1),this.xhr.addEventListener("error",this.getOffsetHandler.bind(this),!1);var e=this.flowObj.opts.query;"function"==typeof e&&(e=e(this));var t={flowGetOffset:1,flowTotalSize:this.size,flowFilename:this.name};this.relativePath&&(t.flowRelativePath=this.relativePath),e=this.flowObj.extend(t,e);var i=this.flowObj.opts.target,s=new FormData;this.flowObj.each(e,function(e,t){s.append(t,e)}),this.xhr.open("POST",i),this.xhr.withCredentials=this.flowObj.opts.withCredentials,this.flowObj.each(this.flowObj.opts.headers,function(e,t){this.xhr.setRequestHeader(t,e)},this),this.xhr.send(s)},reset:function(){this.paused=!1,this.queuePaused=!1,this.uploading=!1,this.currentSpeed=0,this.averageSpeed=0,this.offset=0,this.uploadingChunk=!1,this.completedChunks=0,this.chunks=[]},pause:function(e){if(this.complete)return!1;var t;this.uploading&&(this.uploadingChunk&&this.uploadingChunk.abort(),t=!0),this.reset(),e&&(this.queuePaused=!0),this.paused=!0,this.flowObj.onFilePause(this,e,t)},start:function(){if(this.complete)return!1;this.reset(),this.uploading=!0,this.flowObj.onFileStart(),!this.flowObj.opts.chunkSize||this.size<this.flowObj.opts.chunkSize&&this.size<this.flowObj.opts.resumeLargerThan?(this.prepareChunks(),this.uploadNextChunk()):this.getOffset()},prepareChunks:function(){if(this.flowObj.opts.chunkSize>0)var e=Math.max(Math.ceil((this.file.size-this.offset)/this.flowObj.opts.chunkSize),1);else e=1;for(var t=0;t<e;t++)this.chunks.push(new FlowChunk(this.flowObj,this,t))},removeUploadingChunk:function(){for(var e=this.chunks.length,t=0;t<e;t++)if(this.chunks[t]==this.uploadingChunk)return this.uploadingChunk=null,this.chunks[t]=null,!0;return!1},measureProgress:function(){this.error?this.progress=0:this.complete?this.progress=1:0==this.size&&0==this.completedBytes?this.progress=1:this.progress=this.completedBytes/this.size},timeRemaining:function(){if(this.paused||this.error||this.complete)return 0;var e=this.size-this.completedBytes;return e&&!this.averageSpeed?Number.POSITIVE_INFINITY:e||this.averageSpeed?Math.floor(e/this.averageSpeed):0}},FlowChunk.prototype={getParams:function(){var e={flowTotalSize:this.fileObjSize,flowIsFirstChunk:0==this.startByte?1:0,flowIsLastChunk:this.endByte==this.fileObjSize?1:0};return this.fileObj.relativePath&&(e.flowRelativePath=this.fileObj.relativePath),navigator.userAgent.toLowerCase().indexOf("firefox")>-1&&(e.flowFilename=this.fileObj.name),e},getTarget:function(e){var t=this.flowObj.opts.target;return t.indexOf("?")<0?t+="?":t+="&",t+e.join("&")},send:function(){this.fileObj.uploadingChunk=this,this.loaded=0,this._lastLoaded=0,this.total=0,this.pendingRetry=!1;var e=this.fileObj.file.slice?"slice":this.fileObj.file.mozSlice?"mozSlice":this.fileObj.file.webkitSlice?"webkitSlice":"slice",t=this.fileObj.file[e](this.startByte,this.endByte);this.xhr=new XMLHttpRequest,this.xhr.upload.addEventListener("progress",this.progressHandler,!1),this.xhr.addEventListener("load",this.doneHandler,!1),this.xhr.addEventListener("error",this.doneHandler,!1);var i=this.prepareXhrRequest(t);this.xhr.send(i)},abort:function(){this.xhr&&(this.xhr.abort(),this.loaded&&(this.fileObj.completedBytes-=this.loaded,this.flowObj.completedBytes-=this.loaded)),this.fileObj.chunkEvent("abort")},status:function(){return this.pendingRetry?"uploading":this.xhr?this.xhr.readyState<4?"uploading":this.flowObj.opts.validateChunkResponse.call(this.flowObj.opts.validateChunkResponseScope||this,this.xhr.status,this.xhr.responseText):"pending"},message:function(){return this.xhr?this.xhr.responseText:""},prepareXhrRequest:function(e){var t=this.flowObj.opts.query;"function"==typeof t&&(t=t(this.fileObj,this)),t=this.flowObj.extend(this.getParams(),t);var i=new FormData;return this.flowObj.each(t,function(e,t){i.append(t,e)}),i.append(this.flowObj.opts.fileParameterName,e,this.fileObj.name),this.xhr.open("POST",this.flowObj.opts.target),this.xhr.withCredentials=this.flowObj.opts.withCredentials,this.flowObj.each(this.flowObj.opts.headers,function(e,t){this.xhr.setRequestHeader(t,e)},this),i}};